---
title: "Un joli titre pour le dashboard"
author: "Marie-Pierre Etienne"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "Moodle", href: "https://tice.agrocampus-ouest.fr/course/view.php?id=6726", align: left }
      - { icon: "fa-twitter", href: "https://twitter.com/marie_etienne", align: right }
      - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/marie-etienne-818a7115/", align: right }
params:
  setup_path: ../resources/
---

<style>                     
.navbar {
  background-color:#46ACC8;
  border-color:#46ACC8;
}
.navbar-brand {
color:black!important;
}


</style>   


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(plotly)
library(sf)
library(maps)
```

Importation des données et chargement des packages

```{r data}
religion_brut <- read.csv("WRP national data.csv")
alcool_brut <- read.csv("HappinessAlcoholConsumption.csv")

alcool_religion <- countrycode::codelist %>% 
  select(country.name.en, cowc) %>% 
  rename(Country = country.name.en) %>% 
  right_join(alcool_brut, by = "Country") %>% 
  rename(name = cowc) %>% 
  full_join(religion_brut, by = "name") 
```



### Graphique A : cartes des religions et de l'alcool

```{r}
world_sf <- map_data("world")

religion_main <- religion_brut %>% 
  filter(year==2010) %>% 
  select(name, ends_with("pct"), nonreligpct, -ends_with("genpct"), -sumreligpct,
         hindgenpct, sikhgenpct, shntgenpct, zorogenpct, bahgenpct,
         taogenpct, confgenpct, anmgenpct) %>% 
  pivot_longer(cols = c(ends_with("pct"), nonreligpct), 
               names_to = "religion", values_to = "percent") %>% 
  group_by(name) %>% 
  filter(percent==max(percent)) %>% 
  mutate(religion = as.factor(religion)) %>% 
  mutate(religion = fct_recode(religion,
                               'buddistes' = "budmahpct",
                               'buddistes' = "budothrpct",
                               'buddistes' = "budthrpct",
                               'chrétiens - protestants' = "chrstangpct",
                               'chrétiens - catholiques' = "chrstcatpct",
                               'chrétiens - orthodoxes' = "chrstorthpct",
                               'chrétiens - protestants' = "chrstprotpct",
                               'chrétiens - autres' = "chrstothrpct",
                               'musulmans - sunnites' = "islmsunpct",
                               'musulmans - shiites' = "islmshipct",
                               'musulmans - autres' = "islmothrpct",
                               'juifs orthodoxes' = "judorthpct",
                               'athées' = "nonreligpct",
                               'animistes' = "anmgenpct",
                               'hindous' = "hindgenpct",
                               'shintoistes' = "shntgenpct"
                               ))

palette_religion = c(
  `chrétiens - catholiques` = "#00b4ff",
  `chrétiens - orthodoxes` = "#009eff",
  `chrétiens - protestants` = "#0066ff",
  `chrétiens - autres` = "#004fff",
  `musulmans - sunnites` = "#4d7f17",
  `musulmans - shiites` = "#6bb120",
  `musulmans - autres` = "#8ae429",
  `juifs orthodoxes` = "#ea8611",
  `buddistes` = "#ffd966",
  `athées` = "#cc0000",
  `animistes` = "#7e0f12",
  `hindous` = "#6a329f",
  `shintoistes` = "#c90076"
)

religion_map <- religion_main %>%
  rename(cowc = name) %>% 
  full_join(countrycode::codelist, by = "cowc") %>% 
  select(country.name.en, religion, percent, cowc) %>% 
  rename(region = country.name.en) %>% 
  mutate(region = as.factor(region)) %>% 
  mutate(region = fct_recode(region,
                             "USA" = "United States",
                             "UK" = "United Kingdom",
                             "Antigua" = "Antigua & Barbuda",
                            "Bosnia and Herzegovina"  = "Bosnia & Herzegovina",
                            "Republic of Congo" = "Congo - Brazzaville",
                            "Democratic Republic of the Congo" = "Congo - Kinshasa",
                            "Ivory Coast" = "Côte d’Ivoire",
                            "Czech Republic" = "Czechia",
                            "Myanmar" = "Myanmar (Burma)"
                             )) %>% 
  full_join(world_sf, by = 'region') %>% 
  ggplot() +
  aes(fill = religion, x = long, y = lat, group = group,
      text = paste(round(percent, 2)*100, '%')) +
  geom_polygon() +
  coord_map("mercator", xlim = c(-180,180), ylim = c(-55, 80)) +
  scale_fill_manual(values = palette_religion) +
  xlab('') + ylab('') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  ggtitle("Religions majoritaires dans le monde") 

ggplotly(religion_map)

ceci est un test


```

### Graphique B
Graphique de la consommation de Bière, Vin et Spiritueux en fonction de la religion (majoritaire dans chaque pays)

```{r}
data <- read.delim("~/Agro/5A/Visualisation de donnees/Projet/alcool_religion.csv", sep = ";", dec=".")
religion_main <- data %>% 
  select(Country,ends_with("PerCapita"), ends_with("_percent")) %>% 
  select(-total_percent) %>% 
  pivot_longer(cols = ends_with("_percent"), names_to = "religion", values_to = "percent") %>% 
  group_by(Country) %>% 
  filter(percent==max(percent)) %>% 
  separate(religion, c("main", 'suffix'), sep = '_') %>% 
  select(-suffix) %>% 
  group_by(main) %>% 
  mutate(n = n()) %>% 
  filter(n>1) %>% 
  select(-n) %>% 
  pivot_longer(cols = 3:5, names_to = "Type" ) %>%
  mutate(Type = as.factor(Type))# %>% 


graph2 <- ggplot(data = religion_main)+
  aes(x=main, y=value, fill = Type)+
  geom_boxplot(outlier.shape=NA)+
  scale_fill_manual(values=c("darkgoldenrod1","aquamarine4", "darkred")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
graph2 

```

### Graphique C

```{r}
data <- read.delim("~/Agro/5A/Visualisation de donnees/Projet/alcool_religion.csv", sep = ";", dec=".")
data_islam <- data %>%
  select(starts_with("Beer"),starts_with("Spirit"), starts_with("Wine"), ends_with(("islam_percent"))) %>% 
  rename(Beer = Beer_PerCapita) %>% 
  rename(Spirit = Spirit_PerCapita) %>% 
  rename(Wine = Wine_PerCapita) %>% 
  pivot_longer(cols = 1:3, names_to = "Type" ) %>%
  mutate(Type = as.factor(Type))


graph3 <-ggplot(data=data_islam, aes(x=islam_percent, y= value, color=Type)) +
  geom_point()+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE)+
  scale_color_manual(values=c("darkgoldenrod1","aquamarine4", "darkred"))
graph3

data_athe <- data %>%
  select(starts_with("Beer"),starts_with("Spirit"), starts_with("Wine"), ends_with(("noreligion_percent"))) %>% 
  rename(Beer = Beer_PerCapita) %>% 
  rename(Spirit = Spirit_PerCapita) %>% 
  rename(Wine = Wine_PerCapita) %>% 
  pivot_longer(cols = 1:3, names_to = "Type" ) %>%
  mutate(Type = as.factor(Type))


graph5 <-ggplot(data=data_athe, aes(x=noreligion_percent, y= value, color=Type)) +
  geom_point()+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE)+
  scale_color_manual(values=c("darkgoldenrod1","aquamarine4", "darkred"))
graph5

data_catho <- data %>%
  select(starts_with("Beer"),starts_with("Spirit"), starts_with("Wine"), ends_with(("christianity_percent"))) %>% 
  rename(Beer = Beer_PerCapita) %>% 
  rename(Spirit = Spirit_PerCapita) %>% 
  rename(Wine = Wine_PerCapita) %>% 
  pivot_longer(cols = 1:3, names_to = "Type" ) %>%
  mutate(Type = as.factor(Type))


graph6 <-ggplot(data=data_catho, aes(x=christianity_percent, y= value, color=Type)) +
  geom_point()+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE)+
  scale_color_manual(values=c("darkgoldenrod1","aquamarine4", "darkred"))
graph6

#Test d'un graphique avec les différents courant de l'islam
data_islam2 <- data %>% 
  select(Country, ends_with("PerCapita"), starts_with("islam"), population)%>%
  select(-c(islam_all, islam_percent, islam_other)) %>% 
  mutate(Conso_Beer = Beer_PerCapita/100*population) %>% 
  mutate(Conso_Wine = Wine_PerCapita/100*population) %>% 
  mutate(Conso_Spirit = Spirit_PerCapita/100*population) %>% 
  mutate(Conso_totale = Conso_Spirit+Conso_Wine+Conso_Beer) %>% 
  pivot_longer(cols = starts_with("islam"), names_to = "Type" ) %>%
  mutate(Type = as.factor(Type))

graph4 <-ggplot(data=data_islam2, aes(x=Conso_totale, y= value, color=Type)) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE)
graph4 
```


<!-- Column {data-width=650} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### An easy solution for dashboard -->

<!-- ```{r, echo = TRUE} -->
<!-- #install.package('flexdasboard') -->
<!-- #rmarkdown::draft("dashboard.Rmd", template = "flex_dashboard", package = "flexdashboard") -->
<!-- ``` -->

<!-- The [flexdashboard website](https://rmarkdown.rstudio.com/flexdashboard/index.html) provides multiple advanced examples. -->

<!-- ### Some static graph -->

<!-- ```{r data, eval = TRUE, echo = FALSE, results='hide', message = FALSE, warning=FALSE} -->
<!-- n <- 100 -->
<!-- dta <- tibble(size = round(rnorm(n, mean = 0, sd =10),2),  -->
<!--            color = sample(x= c('Blue', 'Yellow'), size = n, replace = TRUE)) -->

<!-- ``` -->


<!-- ```{r graph_static,  echo = FALSE,  message = FALSE, warning=FALSE} -->
<!-- p1 <- dta %>% ggplot() + -->
<!--   aes(x=color, y = size) + -->
<!--   geom_boxplot(aes(fill= color)) -->
<!-- p1 -->
<!-- ``` -->

<!-- Column {.tabset .tabset-fade} -->
<!-- ----------------------------------------------------------------------- -->


<!-- ### Some dynamic maps -->

<!-- ```{r  ggplotly, echo = TRUE,  eval = TRUE,  message = FALSE, warning=FALSE} -->
<!-- plotly::ggplotly(p1) -->
<!-- ``` -->



<!-- ### Chart C -->

<!-- ```{r} -->

<!-- ``` -->

